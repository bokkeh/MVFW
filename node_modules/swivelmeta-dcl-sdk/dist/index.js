define("swivelmeta-dcl-sdk",["exports","@dcl/ui-scene-utils","@dcl/ecs-scene-utils","@decentraland/Identity","@decentraland/EnvironmentAPI","@decentraland/ParcelIdentity"],(function(e,t,n,i,o,r){"use strict";function a(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var c=a(t),s=a(n),u=function(e){void 0===e&&(e=!0),this.bEnable=e};function l(e,t){return[0,0,t,0,t,e,0,e,t,0,0,0,0,e,t,e]}var d=function(e,t){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},d(e,t)};function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function p(e,t,n,i){return new(n||(n=Promise))((function(o,r){function a(e){try{s(i.next(e))}catch(e){r(e)}}function c(e){try{s(i.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((i=i.apply(e,t||[])).next())}))}function f(e,t){var n,i,o,r,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(r){return function(c){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(o=2&r[0]?i.return:r[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,r[1])).done)return o;switch(i=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,i=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==r[0]&&2!==r[0])){a=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){a.label=r[1];break}if(6===r[0]&&a.label<o[1]){a.label=o[1],o=r;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(r);break}o[2]&&a.ops.pop(),a.trys.pop();continue}r=t.call(e,a)}catch(e){r=[6,e],i=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,c])}}}var v=function(e){function t(t,n,i,o){var r=e.call(this)||this;return r.material=new Material,engine.addEntity(r),r.name=o,r.shape=n,r.shape.withCollisions=!0,r.shape.isPointerBlocker=!0,r.addComponent(n),r.addComponent(i),r.shape instanceof PlaneShape&&(r.shape.uvs=l(1,1)),t instanceof VideoClip?(r.video=t,r.texture=new VideoTexture(r.video),r.texture.loop=!0,r.texture.volume=.5,r.texture.play(),r.mediaType="video",r.addPausePlayVideo(r.mediaType),r.shape instanceof PlaneShape&&(r.shape.uvs=l(-1,1))):t instanceof Texture&&(r.mediaType="image",r.texture=t),r.material.albedoTexture=r.texture,r.material.roughness=1,r.material.specularIntensity=0,r.material.metallic=0,r.material.transparencyMode=1,r.material.emissiveTexture=r.texture,r.material.emissiveColor=Color3.White(),r.material.emissiveIntensity=.5,r.addComponent(r.material),r}return h(t,e),t.prototype.initialize=function(){},t.prototype.updateMedia=function(e){e instanceof VideoClip?(this.texture instanceof VideoTexture&&(this.texture.playing=!1,this.texture=void 0),this.video=e,this.texture=new VideoTexture(this.video),this.texture.loop=!0,this.texture.volume=.5,this.texture.play(),this.mediaType="video",this.addPausePlayVideo(this.mediaType),this.material.albedoTexture=this.texture,this.material.emissiveTexture=this.texture,this.shape instanceof PlaneShape&&(this.shape.uvs=l(-1,1))):e instanceof Texture&&(this.texture instanceof VideoTexture&&(this.texture.playing=!1,this.texture=void 0,this.removeComponent(OnPointerDown)),this.shape instanceof PlaneShape&&(this.shape.uvs=l(1,1)),this.mediaType="image",this.texture=e,this.material.albedoTexture=this.texture,this.material.emissiveTexture=this.texture)},t.prototype.addPausePlayVideo=function(e){var t=this;"video"===e&&this.addComponentOrReplace(new OnPointerDown((function(){t.texture instanceof VideoTexture&&(t.texture.playing=!t.texture.playing)}),{button:ActionButton.PRIMARY,hoverText:"Play/Pause Video",distance:7}))},t.prototype.addUIPanel=function(e,t,n){var i=new g(e,t,n);this.addComponentOrReplace(i),this.addComponentOrReplace(new OnPointerDown((function(){i.openUI()}),{button:ActionButton.PRIMARY,hoverText:"Open Info Panel",distance:7}))},t}(Entity),g=function(e){function t(t,n,i){var o=e.call(this)||this;return o.uiPanel=new c.CustomPrompt,o.info=t,o.image=n,o.imageSize=i,o}return h(t,e),t.prototype.openUI=function(){var e=this;this.uiPanel.show();var t=this.uiPanel.addText(this.info.title,-240,190,Color4.Black(),20);t.text.hTextAlign="left",t.text.font=c.SFFont,t.text.outlineColor=Color4.Black(),t.text.outlineWidth=.2,this.uiPanel.addText("OWNER",30,140,Color4.Gray(),13).text.hTextAlign="left";var i=this.uiPanel.addText("".concat(this.info.owner),30,120,Color4.Black(),13);i.text.hTextAlign="left",i.text.font=c.SFFont,i.text.outlineColor=Color4.Black(),i.text.outlineWidth=.05;var o=this.imageSize.Width,r=this.imageSize.Height,a=n.clamp(o,0,250),s=n.clamp(r,0,250);o>r?s*=r/o:a*=o/r,this.uiPanel.addIcon(this.image.src,35,0,a,s,{sourceWidth:o,sourceHeight:r}).image.hAlign="left",this.uiPanel.addText("DESCRIPTION",30,80,Color4.Gray(),13).text.hTextAlign="left";var u=this.uiPanel.addText(this.info.description,30,60,Color4.Black(),13);u.text.hTextAlign="left",u.text.vTextAlign="top",u.text.paddingLeft=200,u.text.width=500,u.text.textWrapping=!0,u.text.paddingTop=35,u.text.font=c.SFFont,u.text.outlineColor=Color4.Black(),u.text.outlineWidth=.05,this.info.description.slice(0,20);var l=this.info.link,d=this.info.linkText,h=this.uiPanel.addButton("".concat(d),200,-170,(function(){e.uiPanel.hide(),openExternalURL("https://".concat(l))}),c.ButtonStyles.RED);h.label.fontSize=13,h.label.font=c.SFHeavyFont;var p=this.uiPanel.addButton("CANCEL",0,-170,(function(){e.uiPanel.hide()}),c.ButtonStyles.ROUNDBLACK);p.label.fontSize=13,p.label.font=c.SFHeavyFont},t}(ObservableComponent),y="https://discord.com/api/webhooks/969637646303379456/AJFBuiVxj-l4ZesqY3vYIaUizncO2Vlf6hdyJMHf06YE_sRNfs1KnY7pfRSOJHzy2NQ8",m=function(e){function t(t,n,i,o){void 0===n&&(n=!1),void 0===i&&(i=!1),void 0===o&&(o=!1);var r=e.call(this)||this;return r.discordHookURL=y,r.componentObjectPairs=[],r.once=!0,r.projectId=t,r.debug=n,r.bInitializeDiscord=i,r.bLoadOnEnter=o,r.startTime=new Date,r.apiURL="https://prod-swivelmeta.com/core2/query",r.InitializeSwivelMetaServices(t),r.InitializeVisitorData(t),r}return h(t,e),t.prototype.InitializeSwivelMetaServices=function(e){return p(this,void 0,void 0,(function(){var t;return f(this,(function(n){switch(n.label){case 0:if(!this.bInitializeDiscord)return log("InitializeSwivelMetaServices :: bInitDiscord is false, not initializing discord"),[2];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.getDiscordCallbackUrl(e)];case 2:return n.sent()&&(this.debug&&log("Discord Hook URL ::",this.discordHookURL),this.addUserActivitiesListener(e)),[3,4];case 3:return t=n.sent(),log("init_SM_SDK :: Failed to reach URL ::",t),[3,4];case 4:return[2]}}))}))},t.prototype.InitializeVisitorData=function(e){return p(this,void 0,void 0,(function(){var t,n;return f(this,(function(o){switch(o.label){case 0:return[4,i.getUserData()];case 1:return(t=o.sent())&&t.userId?[4,this.getVisitorDataBody(e)]:[3,4];case 2:return n=o.sent(),[4,this.submitFetch(this.assembleVisitorData(n))];case 3:o.sent(),this.debug&&log("onEnterSceneObservable :: assembleVisitorData ::",this.assembleVisitorData(n)),o.label=4;case 4:return[2]}}))}))},t.prototype.getDiscordCallbackUrl=function(e){var t=this;return new Promise((function(n){return p(t,void 0,void 0,(function(){var t,i=this;return f(this,(function(o){switch(o.label){case 0:return t='{\n                    getProjectByUrlName(urlName: "'.concat(e,'") {\n                    discord_callback_url\n                    }\n                    }'),this.debug&&log("queryBody: ",t),[4,this.fetchQuery(t).then((function(e){return e.json()})).then((function(e){var t=e.data.getProjectByUrlName.discord_callback_url;i.debug&&log("getDiscordCallbackUrl :: data ::",t),t&&(i.discordHookURL=t,i.debug&&log("getDiscordCallbackUrl :: discordHookUrl ::",i.discordHookURL),n(i.discordHookURL))})).catch((function(e){i.debug&&log("getDiscordCallbackUrl :: Error ::",e),i.discordHookURL=y}))];case 1:return o.sent(),[2]}}))}))}))},t.prototype.fetchQuery=function(e){return p(this,void 0,void 0,(function(){return f(this,(function(t){return[2,fetch(this.apiURL,{method:"POST",headers:{Accept:"application/json, text/plain, image/*, */*"},body:e.toString()})]}))}))},t.prototype.submitFetch=function(e){return p(this,void 0,void 0,(function(){var t;return f(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,fetch(this.apiURL,{method:"POST",headers:{Accept:"application/json, text/plain, image/*, */*"},body:e.toString()}).then((function(e){return e.json()})).then((function(e){log(e)}))];case 1:return n.sent(),[3,3];case 2:return t=n.sent(),this.debug&&log("submitSignedFetch :: Error :: ".concat(t)),[3,3];case 3:return[2]}}))}))},t.prototype.getConfigData=function(e){return p(this,void 0,void 0,(function(){var t;return f(this,(function(n){return t='{\n            getProjectByUrlName(urlName: "'.concat(e,'") {\n                config\n            }\n        }'),[2,this.fetchQuery(t).then((function(e){return e.json()})).then((function(e){return e.data?e.data:e})).catch((function(e){return log(e)}))]}))}))},t.prototype.sendDiscordNotification=function(e){var t=this;return new Promise((function(n){executeTask((function(){return p(t,void 0,void 0,(function(){var t,i;return f(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),t={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)},[4,fetch(this.discordHookURL,t)];case 1:return o.sent(),n("sent"),[3,3];case 2:return i=o.sent(),this.debug&&log("sendDiscordNotification :: Failed to reach URL ::",i),[3,3];case 3:return[2]}}))}))})).catch((function(e){t.debug&&log("sendDiscordNotification :: Error ::",e)}))}))},t.prototype.transferringTipNotificationDiscord=function(e,t){var n={content:"".concat(this.getCurrentUtcEpochTime(),"Tip of ").concat(e," MANA transferring to ").concat(t)};this.sendDiscordNotification(n)},t.prototype.transferTipCompletionNotificationDiscord=function(e){var t={content:"".concat(this.getCurrentUtcEpochTime(),"Tip successfully transferred to ").concat(e)};this.sendDiscordNotification(t)},t.prototype.generalNotificationDiscord=function(e){var t={content:e=this.getCurrentUtcEpochTime().concat(e)};this.sendDiscordNotification(t)},t.prototype.getCurrentUtcEpochTime=function(){var e=Math.round(Date.now()/1e3);return"<t:".concat(e,":D><t:").concat(e,":T> | ")},t.prototype.sendUserDetailsNotification=function(e,t){return p(this,void 0,void 0,(function(){var n,o;return f(this,(function(r){switch(r.label){case 0:return[4,i.getUserData()];case 1:return(n=r.sent())&&n.userId===t&&(o="".concat(n.displayName),n.publicKey&&(o=o.concat(" (".concat(n.publicKey,")"))),(o=o.concat(" ".concat(e," ")))&&this.generalNotificationDiscord(o)),[2]}}))}))},t.prototype.addUserActivitiesListener=function(e){var t=this;this.debug&&log("ActivitiesListener initialized"),onEnterSceneObservable.add((function(n){return p(t,void 0,void 0,(function(){var t,o;return f(this,(function(r){switch(r.label){case 0:return[4,i.getUserData()];case 1:return(t=r.sent())&&t.userId===n.userId?[4,this.getVisitorDataBody(e)]:[3,3];case 2:o=r.sent(),this.sendUserDetailsNotification("Entered into scene | ".concat(o.room_id),n.userId),this.debug&&log("Entered into scene",n.userId),r.label=3;case 3:return[2]}}))}))})),onLeaveSceneObservable.add((function(e){return p(t,void 0,void 0,(function(){return f(this,(function(t){return this.sendUserDetailsNotification("Left scene",e.userId),this.debug&&log("Left scene",e.userId),[2]}))}))})),onPlayerConnectedObservable.add((function(e){t.debug&&log("new avatar connected :: ",e.userId)})),onPlayerDisconnectedObservable.add((function(e){t.sendUserDetailsNotification("Disconnected",e.userId)}))},t.prototype.getVisitorDataBody=function(e){return p(this,void 0,void 0,(function(){var t,n,a,c,s,u;return f(this,(function(l){switch(l.label){case 0:return[4,i.getUserData()];case 1:return t=l.sent(),[4,o.getCurrentRealm()];case 2:return n=l.sent(),[4,r.getParcel()];case 3:return a=l.sent(),c=a.land.sceneJsonData.scene.base,[4,o.getPlatform()];case 4:return s=l.sent(),u={display_name:t.displayName,wallet_address:null!==t.publicKey?t.publicKey:"",room_id:"".concat(null==n?void 0:n.displayName," | ").concat(c),scene_id:e,device:{type:s,device_address:"",device_detail:""}},this.debug&&log("visitorData :: ",u),[2,u]}}))}))},t.prototype.assembleVisitorData=function(e){var t,n,i;return'mutation {\n            createVisitor(visitor:{\n            \n            display_name: "'.concat(e.display_name,'",\n            email: "",\n            wallet_address: "').concat(e.wallet_address,'",\n            room_id: "').concat(e.room_id,'",\n            scene_id: "').concat(e.scene_id,'",\n            space_time: null,\n            device: {\n            type: "').concat(null===(t=e.device)||void 0===t?void 0:t.type,'",\n            device_address: "').concat(null===(n=e.device)||void 0===n?void 0:n.device_address,'",\n            device_detail: "').concat(null===(i=e.device)||void 0===i?void 0:i.device_detail,'",\n            }\n\n            })\n            {\n            visitor_id\n            }\n            }')},t.prototype.parseConfigData=function(){return p(this,void 0,void 0,(function(){var e=this;return f(this,(function(t){return[2,new Promise((function(t,n){return p(e,void 0,void 0,(function(){var e,i,o,r;return f(this,(function(a){switch(a.label){case 0:e=!1,this.debug&&(e=this.debug),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.getConfigData(this.projectId).then((function(e){return JSON.parse(e.getProjectByUrlName.config)})).then((function(e){if(e)return e}))];case 2:return i=a.sent(),e&&log("Swivel Meta Config Data: ",i),o=i?i.sm_config_pack.components:void 0,e&&log("components :: ",o),log("components :: ",o),t(o),[3,4];case 3:return r=a.sent(),n(r),[3,4];case 4:return[2]}}))}))}))]}))}))},t.prototype.updateMediaOnSceneLoad=function(e,t){return p(this,void 0,void 0,(function(){var n,i,o,r,a,c,s,l,d;return f(this,(function(h){switch(h.label){case 0:return this.componentObjectPairs=e,this.debug&&(t=this.debug),[4,this.parseConfigData()];case 1:n=h.sent(),i=function(e){var i=n[e.component],a=i.parameters[0].default_value,c=e.object;if(t&&log("updateMediaOnSceneLoad :: currentMedia :: ",a),t&&log("updateMediaOnSceneLoad :: currentEntity.name :: ",c.name),t&&log("updateMediaOnSceneLoad :: element.component :: ",i),""===a)return"continue";if(c instanceof Entity)if("dynamic-media"===i.component_type){if(c instanceof v){var s=!!(a.endsWith(".mp4")||a.endsWith(".webm")||a.endsWith(".ogg")||a.endsWith(".m3u8"));void 0!==c.video?c.video:c.video=new VideoClip("");var l=c.texture instanceof Texture?c.texture.src.split("/"):[""],d=a.split("/");if(!o.bLoadOnEnter&&c.video.url===a||!o.bLoadOnEnter&&c.texture instanceof Texture&&l[l.length-1]===d[d.length-1])return"continue";s&&t?log("------------ BEFORE UPDATE ------------\n",c.name,"\n currentMedia: ",a,"\n currentEntity.video.url: ",c.video.url):c.texture instanceof Texture&&log("------------ BEFORE UPDATE ------------\n",c.name,"\n currentMedia: ",d[d.length-1],"\n currentEntity.texture.src: ",l[l.length-1]),s?c.updateMedia(new VideoClip(a)):c.updateMedia(new Texture(a)),s&&t?log("------------ AFTER UPDATE ------------\n",c.name,"\n currentMedia: ",a,"\n currentEntity.video.url: ",c.video.url):c.texture instanceof Texture&&log("------------ AFTER UPDATE ------------\n",c.name,"\n currentMedia: ",d[d.length-1],"\n currentEntity.texture.src: ",l[l.length-1])}}else"dynamic-link"===i.component_type&&null!==c.getComponentOrNull(OnPointerDown)&&(-1!==a.search("decentraland")?(r=a.split("/?")[1].split("&")[0].split("=")[1].split("%2C"))&&(c.getComponent(OnPointerDown).callback=function(){teleportTo("".concat(r[0],",").concat(r[1]))},c.getComponent(OnPointerDown).hoverText="TeleportTo: ".concat(r[0],", ").concat(r[1])):a.startsWith("https://")||a.startsWith("http://")?(c.getComponent(OnPointerDown).callback=function(){openExternalURL(a)},c.getComponent(OnPointerDown).hoverText=a.split("/")[a.split("/").length-1]):NaN!=Number(a.split(",")[0])&&(r=a.split(","),c.getComponent(OnPointerDown).callback=function(){teleportTo("".concat(r[0],",").concat(r[1]))},c.getComponent(OnPointerDown).hoverText="TeleportTo: ".concat(r[0],", ").concat(r[1])));else if("string"===(typeof a).toString()){var h="true"==a.toLowerCase()||"t"==a.toLowerCase()||"1"==a.toLowerCase()||"false"!==a.toLowerCase()&&"f"!==a.toLowerCase()&&"0"!=a.toLowerCase();(i.name.startsWith("Enable")||h)&&c instanceof u&&(c.bEnable=h,log("currentEntity: ",c))}},o=this;try{for(a=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),c=a.next();!c.done;c=a.next())s=c.value,i(s)}catch(e){l={error:e}}finally{try{c&&!c.done&&(d=a.return)&&d.call(a)}finally{if(l)throw l.error}}return[2]}}))}))},t.prototype.updateMediaOnSceneEnter=function(e){return p(this,void 0,void 0,(function(){var t,n=this;return f(this,(function(i){return t=0,onEnterSceneObservable.add((function(){return p(n,void 0,void 0,(function(){return f(this,(function(n){switch(n.label){case 0:return t>0?(this.debug&&log("updateMediaOnSceneEnter :: bSceneUpdateOnParcelEnter :: UPDATE ENTITIES ON SCENE ENTER"),[4,this.updateMediaOnSceneLoad(e,this.debug)]):[3,2];case 1:n.sent(),n.label=2;case 2:return this.debug&&log("updateMediaOnSceneEnter :: bSceneUpdateOnParcelEnterCount :: ",t),log("updateMediaOnSceneEnter :: bSceneUpdateOnParcelEnterCount :: ",t),t++,[2]}}))}))})),[2]}))}))},t}(Entity);e.DynamicMedia=v,e.EnableDisable=u,e.SwivelMetaServices=m,e.debugMessage=function(e){new c.OkPrompt(e,(function(){log("continue")}),"Continue",!0).show()},e.setBoxUVs=function(e,t){return[0,0,t,0,t,e,0,e,t,0,0,0,0,e,t,e,0,0,t,0,t,e,0,e,t,0,0,0,0,e,t,e,t,0,0,0,0,e,t,e,0,0,t,0,t,e,0,e]},e.setCustomUVs=function(e,t,n,i){return void 0===n&&(n=0),void 0===i&&(i=0),[0+n,0+i,t+n,0+i,t+n,e+i,0+n,e+i,t+n,0+i,0+n,0+i,0+n,e+i,t+n,e+i]},e.setTimeout=function(e,t){var n=new Entity;n.addComponent(new s.Delay(e,(function(){t(),engine.removeEntity(n)})))},e.setUVsBasic=l,Object.defineProperty(e,"__esModule",{value:!0})}));
